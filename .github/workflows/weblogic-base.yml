name: Build WebLogic Base Layer

on:
  workflow_dispatch:
  schedule:
    - cron: "0 */6 * * *"

env:
  BASE_IMAGE_REGISTRY: container-registry.oracle.com
  BASE_IMAGE_REPOSITORY: middleware/weblogic
  DOCKERHUB_REPO: partofaplan/weblogic-base

jobs:
  detect-upstream:
    runs-on: ubuntu-latest
    outputs:
      base_image_ref: ${{ steps.digest.outputs.image_ref }}
      base_image_digest: ${{ steps.digest.outputs.digest }}
      base_image_tag: ${{ steps.latest.outputs.tag }}
      should_build: ${{ steps.build_gate.outputs.should_build }}
    steps:
      - uses: actions/checkout@v4

      - name: Log in to Oracle Container Registry
        env:
          OCR_USERNAME: ${{ secrets.OCR_USERNAME }}
          OCR_PASSWORD: ${{ secrets.OCR_PASSWORD }}
        run: |
          if [ -z "$OCR_USERNAME" ] || [ -z "$OCR_PASSWORD" ]; then
            echo "Oracle Container Registry credentials are required." >&2
            exit 1
          fi
          echo "$OCR_PASSWORD" | docker login container-registry.oracle.com -u "$OCR_USERNAME" --password-stdin

      - name: Resolve latest upstream tag
        id: latest
        env:
          OCR_USERNAME: ${{ secrets.OCR_USERNAME }}
          OCR_PASSWORD: ${{ secrets.OCR_PASSWORD }}
        run: |
          python3 scripts/get_latest_tag.py > latest.json
          jq . latest.json
          echo "tag=$(jq -r '.tag' latest.json)" >> "$GITHUB_OUTPUT"
          echo "digest=$(jq -r '.digest' latest.json)" >> "$GITHUB_OUTPUT"
          echo "created=$(jq -r '.created' latest.json)" >> "$GITHUB_OUTPUT"

      - name: Pull upstream image by digest
        env:
          BASE_IMAGE_NAME: ${{ env.BASE_IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_REPOSITORY }}
        run: docker pull "${BASE_IMAGE_NAME}@${{ steps.latest.outputs.digest }}"

      - name: Resolve upstream digest
        id: digest
        env:
          BASE_IMAGE_NAME: ${{ env.BASE_IMAGE_REGISTRY }}/${{ env.BASE_IMAGE_REPOSITORY }}
        run: |
          ref=$(docker image inspect "${BASE_IMAGE_NAME}@${{ steps.latest.outputs.digest }}" --format '{{index .RepoDigests 0}}')
          digest="${ref#*@}"
          echo "digest=${digest}" >> "$GITHUB_OUTPUT"
          echo "image_ref=${BASE_IMAGE_NAME}@${digest}" >> "$GITHUB_OUTPUT"

      - name: Gate on previously processed digest
        id: digest-cache
        uses: actions/cache@v4
        with:
          path: .digest-cache
          key: base-image-${{ steps.digest.outputs.digest }}

      - name: Evaluate build requirement
        id: build_gate
        env:
          CACHE_HIT: ${{ steps.digest-cache.outputs.cache-hit }}
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: |
          mkdir -p .digest-cache
          if [ "$CACHE_HIT" = "true" ]; then
            echo "should_build=false" >> "$GITHUB_OUTPUT"
          else
            printf '%s\n' "$DIGEST" > .digest-cache/latest
            echo "should_build=true" >> "$GITHUB_OUTPUT"
          fi

  build-and-push:
    runs-on: ubuntu-latest
    needs: detect-upstream
    if: needs.detect-upstream.outputs.should_build == 'true'
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Oracle Container Registry
        env:
          OCR_USERNAME: ${{ secrets.OCR_USERNAME }}
          OCR_PASSWORD: ${{ secrets.OCR_PASSWORD }}
        run: |
          echo "$OCR_PASSWORD" | docker login container-registry.oracle.com -u "$OCR_USERNAME" --password-stdin

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          registry: docker.io
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull upstream digest
        run: docker pull "${{ needs.detect-upstream.outputs.base_image_ref }}"

      - name: Smoke test upstream image
        run: scripts/test-base-image.sh "${{ needs.detect-upstream.outputs.base_image_ref }}"

      - name: Derive image metadata
        id: metadata
        run: |
          echo "tag=${{ needs.detect-upstream.outputs.base_image_tag }}" >> "$GITHUB_OUTPUT"

      - name: Build customized image
        env:
          BASE_REF: ${{ needs.detect-upstream.outputs.base_image_ref }}
          TAG: ${{ steps.metadata.outputs.tag }}
        run: |
          docker build \
            --build-arg BASE_IMAGE="$BASE_REF" \
            --tag "${DOCKERHUB_REPO}:latest" \
            --tag "${DOCKERHUB_REPO}:${TAG}" \
            .

      - name: Smoke test customized image
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
        run: scripts/test-custom-image.sh "${DOCKERHUB_REPO}:${TAG}"

      - name: Push image tags
        env:
          TAG: ${{ steps.metadata.outputs.tag }}
        run: |
          docker push "${DOCKERHUB_REPO}:${TAG}"
          docker push "${DOCKERHUB_REPO}:latest"
